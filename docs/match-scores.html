<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Record Match Scores - SideSpins</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .page-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .page-header h1 {
        margin: 0 0 0.5rem 0;
        color: #333;
        font-size: 2rem;
      }

      .match-info {
        color: #666;
        font-size: 1rem;
      }

      .match-info strong {
        color: #333;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
        margin-bottom: 1rem;
      }

      .players-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .players-section h2 {
        margin: 0 0 1.5rem 0;
        color: #333;
        font-size: 1.5rem;
      }

      .player-list {
        display: grid;
        gap: 1rem;
      }

      .player-card {
        background: #f8f9fa;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.2s;
      }

      .player-card.selected {
        border-color: #007cba;
        background: #e7f4fb;
      }

      .player-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .player-name {
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
      }

      .player-skill {
        background: #007cba;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .result-buttons {
        display: flex;
        gap: 0.5rem;
      }

      .result-btn {
        padding: 0.5rem 1rem;
        border: 2px solid #e1e5e9;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
      }

      .result-btn:hover {
        transform: translateY(-1px);
      }

      .result-btn.win {
        border-color: #28a745;
        color: #28a745;
      }

      .result-btn.win.active {
        background: #28a745;
        color: white;
      }

      .result-btn.loss {
        border-color: #dc3545;
        color: #dc3545;
      }

      .result-btn.loss.active {
        background: #dc3545;
        color: white;
      }

      .result-btn.forfeit {
        border-color: #6c757d;
        color: #6c757d;
      }

      .result-btn.forfeit.active {
        background: #6c757d;
        color: white;
      }

      .result-btn.clear {
        border-color: #6c757d;
        color: #6c757d;
        background: #f8f9fa;
      }

      .result-btn.clear:hover {
        background: #e2e3e5;
        border-color: #495057;
      }

      .actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #007cba;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #005a87;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      .instructions {
        background: #e7f4fb;
        border-left: 4px solid #007cba;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
        color: #333;
      }

      .summary {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e1e5e9;
      }

      .summary-row:last-child {
        border-bottom: none;
      }

      .summary-label {
        color: #666;
        font-weight: 500;
      }

      .summary-value {
        font-weight: 600;
        color: #333;
      }

      .summary-value.win {
        color: #28a745;
      }

      .summary-value.loss {
        color: #dc3545;
      }

      .summary-value.forfeit {
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="page-header">
        <h1>Record Match Scores</h1>
        <div class="match-info" id="matchInfo">
          <span>Loading match details...</span>
        </div>
      </div>

      <div id="errorMessage" class="error" style="display: none"></div>
      <div id="loadingMessage" class="loading">Loading team roster...</div>

      <div id="mainContent" style="display: none">
        <div class="players-section">
          <h2>Team Roster</h2>

          <div class="instructions">
            <strong>Instructions:</strong> Click Win, Loss, or Forfeit for each
            player who participated in this match. Only players with recorded
            results will be saved.
          </div>

          <div class="summary" id="summary" style="display: none">
            <div class="summary-row">
              <span class="summary-label">Players with Results:</span>
              <span class="summary-value" id="recordedCount">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Wins:</span>
              <span class="summary-value win" id="winsCount">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Losses:</span>
              <span class="summary-value loss" id="lossesCount">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Forfeits:</span>
              <span class="summary-value forfeit" id="forfeitsCount">0</span>
            </div>
          </div>

          <div class="player-list" id="playerList"></div>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="window.history.back()">
            Cancel
          </button>
          <button
            class="btn btn-primary"
            id="saveBtn"
            onclick="saveScores()"
            disabled
          >
            Save Scores
          </button>
        </div>
      </div>
    </div>

    <div class="success-message" id="successMessage"></div>

    <script src="/assets/auth.js?v=202601020838"></script>
    <script>
      const authManager = new AuthManager();

      let matchId, teamId, divisionId;
      let players = [];
      let playerResults = {}; // { playerId: { result: 'win'|'loss'|'forfeit', skillLevel, playerName } }
      let currentMatch = null;

      async function initialize() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        matchId = urlParams.get("matchId");
        teamId = urlParams.get("teamId");
        divisionId = urlParams.get("divisionId");

        if (!matchId || !teamId || !divisionId) {
          showError(
            "Missing required parameters. Please access this page from the schedule."
          );
          return;
        }

        try {
          // Check authentication
          const isAuthenticated = await authManager.requireAuth(
            "/login-new.html?redirect=" +
              encodeURIComponent(
                window.location.pathname + window.location.search
              )
          );

          if (!isAuthenticated) {
            return;
          }

          // Load memberships to check role
          await authManager.loadUserMemberships();

          // Verify captain role
          if (!authManager.hasTeamRole("captain")) {
            showError("You must be a team captain to record match scores.");
            return;
          }

          // Load match details
          await loadMatchDetails();

          // Load team roster
          await loadTeamRoster();

          // Load existing scores if any
          await loadExistingScores();

          document.getElementById("loadingMessage").style.display = "none";
          document.getElementById("mainContent").style.display = "block";
        } catch (error) {
          console.error("Initialization error:", error);
          showError("Failed to load match data: " + error.message);
        }
      }

      async function loadMatchDetails() {
        try {
          const response = await authManager.makeAuthenticatedRequest(
            `${authManager.baseUrl}/GetMatches?divisionId=${divisionId}`,
            { method: "GET" }
          );

          if (!response.ok) {
            throw new Error("Failed to load match details");
          }

          const matches = await response.json();
          currentMatch = matches.find((m) => m.id === matchId);

          if (!currentMatch) {
            throw new Error("Match not found");
          }

          // Display match info
          const matchDate = new Date(currentMatch.scheduledAt);
          document.getElementById("matchInfo").innerHTML = `
            <strong>${currentMatch.homeTeamName || "Home"}</strong> vs 
            <strong>${currentMatch.awayTeamName || "Away"}</strong> - 
            ${matchDate.toLocaleDateString()} at ${matchDate.toLocaleTimeString(
            [],
            { hour: "2-digit", minute: "2-digit" }
          )}
          `;
        } catch (error) {
          console.error("Error loading match details:", error);
          throw error;
        }
      }

      async function loadTeamRoster() {
        try {
          const response = await authManager.makeAuthenticatedRequest(
            `${authManager.baseUrl}/teams/${teamId}/memberships`,
            { method: "GET" }
          );

          if (!response.ok) {
            throw new Error("Failed to load team roster");
          }

          const memberships = await response.json();

          // Load all players
          const playersResponse = await authManager.makeAuthenticatedRequest(
            `${authManager.baseUrl}/GetPlayers`,
            { method: "GET" }
          );

          if (!playersResponse.ok) {
            throw new Error("Failed to load players");
          }

          const allPlayers = await playersResponse.json();

          // Create a map of player ID to player data
          const playerMap = {};
          allPlayers.forEach((p) => {
            playerMap[p.id] = p;
          });

          // Build the players list from active memberships
          players = memberships
            .filter((m) => !m.leftAt) // Only active members
            .map((m) => {
              const player = playerMap[m.playerId];
              if (player) {
                // Add skill level from membership
                player.skillLevel = m.skillLevel_9b || 3;
                return player;
              }
              return null;
            })
            .filter((p) => p !== null);

          // Sort by name
          players.sort((a, b) => {
            const aName = `${a.firstName} ${a.lastName}`;
            const bName = `${b.firstName} ${b.lastName}`;
            return aName.localeCompare(bName);
          });

          renderPlayerList();
        } catch (error) {
          console.error("Error loading team roster:", error);
          throw error;
        }
      }

      async function loadExistingScores() {
        if (
          currentMatch &&
          currentMatch.playerMatches &&
          currentMatch.playerMatches.length > 0
        ) {
          // Pre-populate existing scores
          currentMatch.playerMatches.forEach((pm) => {
            playerResults[pm.playerId] = {
              result: pm.result,
              skillLevel: pm.skillLevel,
              playerName: pm.playerName,
            };
          });
          renderPlayerList();
          updateSummary();
        }
      }

      function renderPlayerList() {
        const listContainer = document.getElementById("playerList");
        listContainer.innerHTML = "";

        players.forEach((player) => {
          const playerName = `${player.firstName} ${player.lastName}`;
          const skillLevel = player.skillLevel || 3;
          const currentResult = playerResults[player.id]?.result;

          const card = document.createElement("div");
          card.className = `player-card ${currentResult ? "selected" : ""}`;
          card.innerHTML = `
            <div class="player-info">
              <span class="player-name">${playerName}</span>
              <span class="player-skill">SL ${skillLevel}</span>
            </div>
            <div class="result-buttons">
              <button class="result-btn win ${
                currentResult === "win" ? "active" : ""
              }" 
                      onclick="setResult('${
                        player.id
                      }', 'win', ${skillLevel}, '${playerName}')">
                Win
              </button>
              <button class="result-btn loss ${
                currentResult === "loss" ? "active" : ""
              }" 
                      onclick="setResult('${
                        player.id
                      }', 'loss', ${skillLevel}, '${playerName}')">
                Loss
              </button>
              <button class="result-btn forfeit ${
                currentResult === "forfeit" ? "active" : ""
              }" 
                      onclick="setResult('${
                        player.id
                      }', 'forfeit', ${skillLevel}, '${playerName}')">
                Forfeit
              </button>
              ${
                currentResult
                  ? `<button class="result-btn clear" 
                            onclick="clearResult('${player.id}')">
                      âœ• Clear
                    </button>`
                  : ""
              }
            </div>
          `;
          listContainer.appendChild(card);
        });
      }

      function setResult(playerId, result, skillLevel, playerName) {
        playerResults[playerId] = { result, skillLevel, playerName };
        renderPlayerList();
        updateSummary();
      }

      function clearResult(playerId) {
        delete playerResults[playerId];
        renderPlayerList();
        updateSummary();
      }

      function updateSummary() {
        const resultsCount = Object.keys(playerResults).length;
        const wins = Object.values(playerResults).filter(
          (r) => r.result === "win"
        ).length;
        const losses = Object.values(playerResults).filter(
          (r) => r.result === "loss"
        ).length;
        const forfeits = Object.values(playerResults).filter(
          (r) => r.result === "forfeit"
        ).length;

        document.getElementById("recordedCount").textContent = resultsCount;
        document.getElementById("winsCount").textContent = wins;
        document.getElementById("lossesCount").textContent = losses;
        document.getElementById("forfeitsCount").textContent = forfeits;

        // Show/hide summary
        const summaryDiv = document.getElementById("summary");
        summaryDiv.style.display = resultsCount > 0 ? "block" : "none";

        // Enable/disable save button
        document.getElementById("saveBtn").disabled = resultsCount === 0;
      }

      async function saveScores() {
        if (Object.keys(playerResults).length === 0) {
          showError("Please select results for at least one player.");
          return;
        }

        const saveBtn = document.getElementById("saveBtn");
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        try {
          // Build playerMatches array
          const playerMatches = Object.entries(playerResults).map(
            ([playerId, data]) => ({
              playerId: playerId,
              playerName: data.playerName,
              skillLevel: data.skillLevel,
              result: data.result,
            })
          );

          const response = await authManager.makeAuthenticatedRequest(
            `${authManager.baseUrl}/teams/${teamId}/matches/${matchId}/scores?divisionId=${divisionId}`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(playerMatches),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to save scores");
          }

          showSuccess("Match scores saved successfully!");

          // Redirect back to schedule after 2 seconds
          setTimeout(() => {
            window.location.href = "/schedule-new.html";
          }, 2000);
        } catch (error) {
          console.error("Error saving scores:", error);
          showError("Failed to save scores: " + error.message);
          saveBtn.disabled = false;
          saveBtn.textContent = "Save Scores";
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        document.getElementById("loadingMessage").style.display = "none";
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("successMessage");
        successDiv.textContent = message;
        successDiv.style.display = "block";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", initialize);
    </script>
  </body>
</html>
