<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Team Administration - SideSpins</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        line-height: 1.6;
      }

      .header {
        background: white;
        border-bottom: 1px solid #e1e5e9;
        padding: 1rem 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007cba;
      }

      .nav-links {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-links a {
        color: #666;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: background-color 0.2s;
      }

      .nav-links a:hover {
        background-color: #f8f9fa;
      }

      .nav-links a.active {
        background-color: #007cba;
        color: white;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .team-switcher {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .team-switcher label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
      }

      .team-select {
        padding: 0.5rem 1rem;
        border: 1px solid #e1e5e9;
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
        min-width: 200px;
      }

      .team-select:focus {
        outline: none;
        border-color: #007cba;
      }

      .user-avatar-container {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .captain-badge {
        background: #ffc107;
        color: #212529;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid #ffd60a;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #007cba;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }

      .user-avatar:hover {
        background: #005a87;
        border-color: #007cba;
      }

      .user-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        background: white;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 150px;
        z-index: 1000;
        display: none;
      }

      .user-dropdown.show {
        display: block;
      }

      .user-dropdown-item {
        display: block;
        padding: 0.75rem 1rem;
        color: #333;
        text-decoration: none;
        transition: background-color 0.2s;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-size: 0.9rem;
      }

      .user-dropdown-item:hover {
        background-color: #f8f9fa;
      }

      .user-dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }

      .user-dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }

      .user-dropdown-item.logout {
        color: #dc3545;
        border-top: 1px solid #e1e5e9;
      }

      .user-dropdown-item.logout:hover {
        background-color: #f8d7da;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .page-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .page-header h1 {
        margin-top: 0;
        color: #333;
        font-size: 2rem;
      }

      .page-header .description {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 1rem;
      }

      .team-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .team-info h3 {
        margin-top: 0;
        color: #495057;
        font-size: 1.1rem;
      }

      .admin-sections {
        display: grid;
        gap: 2rem;
      }

      .admin-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e1e5e9;
      }

      .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .section-actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background-color: #007cba;
        color: white;
      }

      .btn-primary:hover {
        background-color: #005a87;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #545b62;
      }

      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }

      /* Team Members Section */
      .members-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }

      .members-table th,
      .members-table td {
        padding: 1rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      .members-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .members-table tbody tr:hover {
        background: #f8f9fa;
      }

      .member-name {
        font-weight: 600;
        color: #333;
      }

      .member-apa {
        color: #666;
        font-size: 0.9rem;
      }

      .role-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 12px;
      }

      .role-captain {
        background-color: #ffc107;
        color: #212529;
        border: 1px solid #ffd60a;
      }

      .role-player {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .role-manager {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .skill-level {
        font-weight: 600;
        font-size: 1.1rem;
        color: #007cba;
      }

      .status-badge {
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 12px;
      }

      .status-badge.active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .member-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      /* Add Member Section */
      .add-member-form {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
        display: none;
      }

      .add-member-form.show {
        display: block;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }

      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e1e5e9;
        border-radius: 6px;
        font-size: 1rem;
        background: white;
      }

      .form-control:focus {
        outline: none;
        border-color: #007cba;
        box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.2);
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
      }

      /* Player Search */
      .player-search {
        position: relative;
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e1e5e9;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .search-results.show {
        display: block;
      }

      .search-result-item {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s;
      }

      .search-result-item:hover {
        background: #f8f9fa;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      .search-result-name {
        font-weight: 600;
        color: #333;
      }

      .search-result-info {
        font-size: 0.9rem;
        color: #666;
      }

      /* Role selector */
      .role-select {
        padding: 0.5rem;
        border: 1px solid #e1e5e9;
        border-radius: 4px;
        background: white;
        font-size: 0.9rem;
      }

      .role-select:focus {
        outline: none;
        border-color: #007cba;
      }

      /* Skill level selector */
      .skill-select {
        padding: 0.4rem;
        border: 1px solid #e1e5e9;
        border-radius: 4px;
        background: white;
        font-size: 0.9rem;
        width: 80px;
      }

      .skill-select:focus {
        outline: none;
        border-color: #007cba;
      }

      .skill-level.editable {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* Loading and Error States */
      .loading {
        text-align: center;
        padding: 3rem;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007cba;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
      }

      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
      }

      .no-team {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        color: #666;
      }

      .no-team a {
        color: #007cba;
        text-decoration: none;
      }

      .no-team a:hover {
        text-decoration: underline;
      }

      .permission-message {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: center;
      }

      /* Hamburger menu button - hidden by default */
      .hamburger-menu {
        display: none;
        flex-direction: column;
        cursor: pointer;
        padding: 0.5rem;
        background: none;
        border: none;
        border-radius: 4px;
      }

      .hamburger-menu:hover {
        background-color: #f8f9fa;
      }

      .hamburger-line {
        width: 20px;
        height: 2px;
        background-color: #666;
        margin: 2px 0;
        transition: 0.3s;
        border-radius: 1px;
      }

      /* Mobile navigation overlay */
      .mobile-nav-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .mobile-nav-overlay.show {
        display: block;
      }

      .mobile-nav-menu {
        position: fixed;
        top: 0;
        right: -300px;
        width: 250px;
        height: 100%;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        padding: 2rem 0;
      }

      .mobile-nav-menu.show {
        right: 0;
      }

      .mobile-nav-header {
        padding: 0 1.5rem 1rem;
        border-bottom: 1px solid #e1e5e9;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .mobile-nav-title {
        font-weight: 600;
        color: #333;
      }

      .mobile-nav-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #666;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
      }

      .mobile-nav-close:hover {
        background-color: #f8f9fa;
      }

      .mobile-nav-links {
        display: flex;
        flex-direction: column;
        padding: 0;
        margin: 0;
      }

      .mobile-nav-links a {
        display: block;
        padding: 1rem 1.5rem;
        color: #666;
        text-decoration: none;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s;
      }

      .mobile-nav-links a:hover {
        background-color: #f8f9fa;
      }

      .mobile-nav-links a.active {
        background-color: #007cba;
        color: white;
      }

      .mobile-team-switcher {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f3f4;
      }

      .mobile-team-switcher label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .mobile-team-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e1e5e9;
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
      }

      .mobile-user-info {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e1e5e9;
        margin-top: auto;
      }

      @media (max-width: 768px) {
        .header-content {
          padding: 0 1rem;
        }

        /* Hide desktop navigation on mobile */
        .nav-links {
          display: none;
        }

        /* Show hamburger menu on mobile */
        .hamburger-menu {
          display: flex;
        }

        /* Hide desktop team switcher on mobile */
        .team-switcher {
          display: none;
        }

        /* Keep user avatar but hide dropdown on mobile (handled by hamburger menu) */
        .user-avatar-container .user-dropdown {
          display: none;
        }

        /* Adjust container padding */
        .container {
          padding: 1rem;
        }

        .page-header,
        .admin-section {
          padding: 1.5rem;
        }

        .section-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .members-table {
          font-size: 0.9rem;
        }

        .members-table th,
        .members-table td {
          padding: 0.75rem 0.5rem;
        }

        .member-actions {
          flex-direction: column;
        }

        .form-actions {
          flex-direction: column;
        }
      }

      /* Session Management Styles */
      .session-card {
        background: white;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: box-shadow 0.2s;
      }

      .session-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .session-card.active {
        border-color: #28a745;
        border-width: 2px;
        background-color: #f0fff4;
      }

      .session-info {
        flex: 1;
      }

      .session-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }

      .session-dates {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .session-meta {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .session-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .session-badge.active {
        background-color: #28a745;
        color: white;
      }

      .session-badge.inactive {
        background-color: #6c757d;
        color: white;
      }

      .session-match-count {
        color: #666;
        font-size: 0.9rem;
      }

      .session-actions {
        display: flex;
        gap: 0.5rem;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-content h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">SideSpins</div>

        <!-- Desktop Navigation -->
        <div class="nav-links">
          <a href="/app.html">Dashboard</a>
          <a href="/schedule-new.html?v=2">Schedule</a>
          <a href="/lineup-explorer-new.html?v=2">Lineup Explorer</a>
          <a href="/team-admin.html" class="active nav-team-admin"
            >Team Admin</a
          >
        </div>

        <div class="user-info">
          <!-- Desktop Team Switcher -->
          <div class="team-switcher">
            <label for="team-select">Team:</label>
            <select id="team-select" class="team-select">
              <option value="">Loading...</option>
            </select>
          </div>

          <div class="user-avatar-container">
            <div id="captain-badge" class="captain-badge" style="display: none">
              CAPT
            </div>
            <div id="user-avatar" class="user-avatar">U</div>
            <div id="user-dropdown" class="user-dropdown">
              <button class="user-dropdown-item logout" id="logout-btn">
                Logout
              </button>
            </div>
          </div>

          <!-- Mobile Hamburger Menu -->
          <button class="hamburger-menu" id="hamburger-menu">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay">
      <div class="mobile-nav-menu" id="mobile-nav-menu">
        <div class="mobile-nav-header">
          <div class="mobile-nav-title">Menu</div>
          <button class="mobile-nav-close" id="mobile-nav-close">
            &times;
          </button>
        </div>

        <div class="mobile-team-switcher">
          <label for="mobile-team-select">Team:</label>
          <select id="mobile-team-select" class="mobile-team-select">
            <option value="">Loading...</option>
          </select>
        </div>

        <div class="mobile-nav-links">
          <a href="/app.html">Dashboard</a>
          <a href="/schedule-new.html?v=2">Schedule</a>
          <a href="/lineup-explorer-new.html?v=2">Lineup Explorer</a>
          <a href="/team-admin.html" class="active nav-team-admin"
            >Team Admin</a
          >
        </div>

        <div class="mobile-user-info">
          <button class="user-dropdown-item logout" id="mobile-logout-btn">
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading team administration...</p>
      </div>

      <div id="no-team" class="no-team" style="display: none">
        <h2>No Team Selected</h2>
        <p>
          Please select a team from the dropdown above to manage team members.
        </p>
      </div>

      <div
        id="permission-denied"
        class="permission-message"
        style="display: none"
      >
        <h3>Permission Required</h3>
        <p>
          You need to be a team captain or manager to access team administration
          features.
        </p>
      </div>

      <div id="error-message" class="error" style="display: none"></div>

      <div id="main-content" style="display: none">
        <div class="page-header">
          <h1>Team Administration</h1>
          <p class="description">
            Manage your team members, roles, and roster.
          </p>
          <div class="team-info">
            <h3 id="current-team-name">Loading...</h3>
            <p id="current-team-role">Role: Loading...</p>
          </div>
        </div>

        <div class="admin-sections">
          <!-- Team Members Section -->
          <div class="admin-section">
            <div class="section-header">
              <h2 class="section-title">Team Members</h2>
              <div class="section-actions">
                <button id="add-member-btn" class="btn btn-primary">
                  <span>➕</span> Add Member
                </button>
              </div>
            </div>

            <div id="members-list">
              <p>Loading team members...</p>
            </div>

            <!-- Add Member Form -->
            <div id="add-member-form" class="add-member-form">
              <h3>Add New Team Member</h3>
              <form id="add-member-form-element">
                <div class="form-group">
                  <label for="player-search">Search Player</label>
                  <div class="player-search">
                    <input
                      type="text"
                      id="player-search"
                      class="form-control"
                      placeholder="Type player name or APA number..."
                    />
                    <div id="search-results" class="search-results"></div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="member-role">Role</label>
                  <select id="member-role" class="form-control">
                    <option value="player">Player</option>
                    <option value="captain">Captain</option>
                    <option value="manager">Manager</option>
                  </select>
                </div>

                <div class="form-actions">
                  <button
                    type="button"
                    id="cancel-add-btn"
                    class="btn btn-secondary"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    id="save-member-btn"
                    class="btn btn-primary"
                  >
                    Add Member
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Sessions Section -->
          <div class="admin-section">
            <div class="section-header">
              <h2 class="section-title">Seasons/Sessions</h2>
              <div class="section-actions">
                <button id="add-session-btn" class="btn btn-primary">
                  <span>➕</span> Create Session
                </button>
              </div>
            </div>

            <div id="sessions-list">
              <p>Loading sessions...</p>
            </div>

            <!-- Add/Edit Session Form (Modal) -->
            <div id="session-modal" class="modal" style="display: none">
              <div class="modal-content">
                <h3 id="session-modal-title">Create Session</h3>
                <form id="session-form-element">
                  <div class="form-group">
                    <label for="session-name">Session Name *</label>
                    <input
                      type="text"
                      id="session-name"
                      class="form-control"
                      placeholder="e.g., Fall 2025, Winter 2026"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="session-start-date">Start Date *</label>
                    <input
                      type="date"
                      id="session-start-date"
                      class="form-control"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="session-end-date">End Date *</label>
                    <input
                      type="date"
                      id="session-end-date"
                      class="form-control"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label>
                      <input
                        type="checkbox"
                        id="session-is-active"
                        style="margin-right: 0.5rem"
                      />
                      Active
                    </label>
                  </div>

                  <div class="form-actions">
                    <button
                      type="button"
                      id="cancel-session-btn"
                      class="btn btn-secondary"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      id="save-session-btn"
                      class="btn btn-primary"
                    >
                      Save
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/assets/auth.js?v=202512300942"></script>
    <script>
      class TeamAdminApp {
        constructor() {
          this.authManager = new AuthManager();
          this.currentTeamId = null;
          this.currentMembership = null;
          this.teamMembers = [];
          this.allPlayers = [];
          this.selectedPlayer = null;
          this.sessions = [];
          this.editingSessionId = null;

          // Bind methods
          this.handleTeamChange = this.handleTeamChange.bind(this);
          this.showAddMemberForm = this.showAddMemberForm.bind(this);
          this.hideAddMemberForm = this.hideAddMemberForm.bind(this);
          this.handlePlayerSearch = this.handlePlayerSearch.bind(this);
          this.handleAddMember = this.handleAddMember.bind(this);
          this.handleUpdateMemberRole = this.handleUpdateMemberRole.bind(this);
          this.handleUpdateMemberSkill =
            this.handleUpdateMemberSkill.bind(this);
          this.handleRemoveMember = this.handleRemoveMember.bind(this);
          this.showSessionModal = this.showSessionModal.bind(this);
          this.hideSessionModal = this.hideSessionModal.bind(this);
          this.handleSaveSession = this.handleSaveSession.bind(this);
          this.handleEditSession = this.handleEditSession.bind(this);
          this.handleDeleteSession = this.handleDeleteSession.bind(this);
          this.handleToggleSessionActive =
            this.handleToggleSessionActive.bind(this);
        }

        async initialize() {
          try {
            // Check authentication
            const isAuthenticated = await this.authManager.requireAuth();
            if (!isAuthenticated) return;

            // Setup UI
            this.setupEventListeners();
            UIPermissions.setAuthManager(this.authManager);
            UIPermissions.setupTeamChangeListener();

            // Load initial data
            await this.loadUserMemberships();
            await this.loadAllPlayers();

            this.hideLoading();

            // Load team data if team is selected
            if (this.authManager.activeTeamId) {
              await this.loadTeamData();
            } else {
              this.showNoTeam();
            }
          } catch (error) {
            console.error("Failed to initialize team admin app:", error);
            this.showError(
              "Failed to load team administration. Please try refreshing the page."
            );
            this.hideLoading();
          }
        }

        setupEventListeners() {
          // Mobile navigation
          this.mobileNav = new MobileNavigation();
          this.mobileNav.init();

          // Team switcher
          const teamSelect = document.getElementById("team-select");
          teamSelect.addEventListener("change", this.handleTeamChange);

          // Team change events
          window.addEventListener("teamChanged", (event) => {
            this.currentTeamId = event.detail.teamId;
            this.currentMembership = event.detail.membership;
            this.loadTeamData();
          });

          // Add member form
          document
            .getElementById("add-member-btn")
            .addEventListener("click", this.showAddMemberForm);
          document
            .getElementById("cancel-add-btn")
            .addEventListener("click", this.hideAddMemberForm);
          document
            .getElementById("add-member-form-element")
            .addEventListener("submit", this.handleAddMember);

          // Player search
          document
            .getElementById("player-search")
            .addEventListener("input", this.handlePlayerSearch);

          // Session management
          document
            .getElementById("add-session-btn")
            .addEventListener("click", this.showSessionModal);
          document
            .getElementById("cancel-session-btn")
            .addEventListener("click", this.hideSessionModal);
          document
            .getElementById("session-form-element")
            .addEventListener("submit", this.handleSaveSession);

          // Close modal when clicking outside
          document
            .getElementById("session-modal")
            .addEventListener("click", (e) => {
              if (e.target.id === "session-modal") {
                this.hideSessionModal();
              }
            });

          // Avatar dropdown
          const userAvatar = document.getElementById("user-avatar");
          const userDropdown = document.getElementById("user-dropdown");

          userAvatar.addEventListener("click", (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle("show");
          });

          document.addEventListener("click", () => {
            userDropdown.classList.remove("show");
          });

          // Logout
          document
            .getElementById("logout-btn")
            .addEventListener("click", async () => {
              try {
                await this.authManager.logout();
                // Use safeRedirect if available, fallback to window.location.href
                if (typeof this.authManager.safeRedirect === "function") {
                  this.authManager.safeRedirect("/login.html");
                } else {
                  window.location.href = window.location.origin + "/login.html";
                }
              } catch (error) {
                console.error("Logout failed:", error);
                if (typeof this.authManager.safeRedirect === "function") {
                  this.authManager.safeRedirect("/login.html");
                } else {
                  window.location.href = window.location.origin + "/login.html";
                }
              }
            });
        }

        async loadUserMemberships() {
          try {
            const memberships = await this.authManager.loadUserMemberships();
            this.populateTeamSwitcher(memberships);
            this.updateUserAvatar();
          } catch (error) {
            console.error("Failed to load memberships:", error);
            this.showError("Failed to load team memberships.");
          }
        }

        async loadAllPlayers() {
          try {
            // Try different possible endpoints for getting players
            let response = await this.authManager.apiRequest("/GetPlayers");
            if (!response.ok) {
              // Try alternative endpoint
              response = await this.authManager.apiRequest("/api/GetPlayers");
            }
            if (response.ok) {
              this.allPlayers = await response.json();
              console.log("Loaded players:", this.allPlayers.length);
            } else {
              console.warn(
                "No player endpoint available, search will be limited"
              );
            }
          } catch (error) {
            console.error("Failed to load players:", error);
            // Non-critical error, continue without player search
          }
        }

        populateTeamSwitcher(memberships) {
          const teamSelect = document.getElementById("team-select");
          const mobileTeamSelect =
            document.getElementById("mobile-team-select");

          teamSelect.innerHTML = "";
          if (mobileTeamSelect) {
            mobileTeamSelect.innerHTML = "";
          }

          if (memberships.length === 0) {
            teamSelect.innerHTML =
              '<option value="">No teams available</option>';
            if (mobileTeamSelect) {
              mobileTeamSelect.innerHTML =
                '<option value="">No teams available</option>';
            }
            return;
          }

          memberships.forEach((membership) => {
            // Desktop option
            const option = document.createElement("option");
            option.value = membership.teamId;
            option.textContent =
              membership.teamName || `Team ${membership.teamId}`;
            if (membership.teamId === this.authManager.activeTeamId) {
              option.selected = true;
            }
            teamSelect.appendChild(option);

            // Mobile option
            if (mobileTeamSelect) {
              const mobileOption = document.createElement("option");
              mobileOption.value = membership.teamId;
              mobileOption.textContent =
                membership.teamName || `Team ${membership.teamId}`;
              if (membership.teamId === this.authManager.activeTeamId) {
                mobileOption.selected = true;
              }
              mobileTeamSelect.appendChild(mobileOption);
            }
          });

          // Update mobile nav if it exists
          if (this.mobileNav && memberships.length > 0) {
            this.mobileNav.updateTeamOptions(
              memberships,
              this.authManager.activeTeamId
            );
          }
        }

        updateUserAvatar() {
          const userAvatar = document.getElementById("user-avatar");
          const captainBadge = document.getElementById("captain-badge");

          if (this.authManager.currentUser) {
            const user = this.authManager.currentUser;
            const initials =
              (user.firstName?.[0] || "") + (user.lastName?.[0] || "");
            userAvatar.textContent = initials || "U";
          }

          // Update captain badge
          const currentMembership = this.authManager.getActiveMembership();
          if (
            currentMembership &&
            ["captain", "manager"].includes(
              currentMembership.role.toLowerCase()
            )
          ) {
            captainBadge.style.display = "block";
          } else {
            captainBadge.style.display = "none";
          }
        }

        async handleTeamChange() {
          const teamSelect = document.getElementById("team-select");
          const selectedTeamId = teamSelect.value;

          if (
            selectedTeamId &&
            selectedTeamId !== this.authManager.activeTeamId
          ) {
            this.authManager.setActiveTeam(selectedTeamId);
          }
        }

        async loadTeamData() {
          try {
            // Check permissions
            if (!this.authManager.hasTeamRole("captain")) {
              this.showPermissionDenied();
              return;
            }

            this.showMainContent();

            // Update team info
            this.updateTeamHeader();

            // Load team members and sessions
            await Promise.all([this.loadTeamMembers(), this.loadSessions()]);
          } catch (error) {
            console.error("Failed to load team data:", error);
            this.showError(
              "Failed to load team data. Please try refreshing the page."
            );
          }
        }

        updateTeamHeader() {
          const currentMembership = this.authManager.getActiveMembership();
          const teamNameElement = document.getElementById("current-team-name");
          const teamRoleElement = document.getElementById("current-team-role");

          if (currentMembership) {
            teamNameElement.textContent =
              currentMembership.teamName || `Team ${currentMembership.teamId}`;
            teamRoleElement.textContent = `Role: ${this.formatRole(
              currentMembership.role
            )}`;
          }
        }

        async loadTeamMembers() {
          try {
            const response = await this.authManager.apiRequest(
              `/teams/${this.authManager.activeTeamId}/memberships`
            );

            if (response.ok) {
              const memberships = await response.json();
              console.log("Raw memberships:", memberships);

              // Enrich memberships with player details
              this.teamMembers = await this.enrichMembershipsWithPlayerDetails(
                memberships
              );
              console.log("Enriched memberships:", this.teamMembers);

              this.renderMembersList();
            } else {
              throw new Error("Failed to load team members");
            }
          } catch (error) {
            console.error("Failed to load team members:", error);
            this.showError("Failed to load team members.");
          }
        }

        async enrichMembershipsWithPlayerDetails(memberships) {
          const enrichedMembers = [];

          for (const membership of memberships) {
            try {
              // Try to get player details from our cached players first
              let playerDetails = this.allPlayers.find(
                (p) => p.id === membership.playerId
              );

              // If not found in cache, try to fetch individual player details
              if (!playerDetails) {
                console.log(
                  `Player ${membership.playerId} not found in cache, attempting individual fetch`
                );
                playerDetails = {
                  id: membership.playerId,
                  firstName: "Unknown",
                  lastName: "Player",
                  apaNumber: "N/A",
                  skillLevel: "N/A",
                };
              }

              // Merge membership and player data
              const enrichedMember = {
                id: membership.id,
                playerId: membership.playerId,
                teamId: membership.teamId,
                role: membership.role,
                active: membership.active !== false, // Default to true if not specified
                skillLevel:
                  membership.skillLevel_9b || playerDetails.skillLevel || null,
                skillLevel_9b: membership.skillLevel_9b, // Keep original field for API updates
                firstName: playerDetails.firstName || "Unknown",
                lastName: playerDetails.lastName || "Player",
                apaNumber: playerDetails.apaNumber || "N/A",
                joinedAt: membership.joinedAt,
                leftAt: membership.leftAt,
              };

              enrichedMembers.push(enrichedMember);
            } catch (error) {
              console.error(
                `Failed to enrich membership ${membership.id}:`,
                error
              );
              // Add with minimal data
              enrichedMembers.push({
                id: membership.id,
                playerId: membership.playerId,
                teamId: membership.teamId,
                role: membership.role,
                active: membership.active !== false,
                skillLevel: membership.skillLevel_9b || null,
                skillLevel_9b: membership.skillLevel_9b,
                firstName: "Unknown",
                lastName: "Player",
                apaNumber: "N/A",
              });
            }
          }

          return enrichedMembers;
        }

        renderMembersList() {
          const membersListElement = document.getElementById("members-list");

          if (this.teamMembers.length === 0) {
            membersListElement.innerHTML =
              '<p>No team members found. Use the "Add Member" button to add players to your team.</p>';
            return;
          }

          const tableHTML = `
                    <table class="members-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>APA Number</th>
                                <th>Role</th>
                                <th>Skill Level</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.teamMembers
                              .map((member) => this.renderMemberRow(member))
                              .join("")}
                        </tbody>
                    </table>
                `;

          membersListElement.innerHTML = tableHTML;
          this.attachMemberEventListeners();
        }

        renderMemberRow(member) {
          const canEdit = this.authManager.hasTeamRole("captain");
          const isCurrentUser =
            member.playerId === this.authManager.currentUser?.playerId;

          return `
                    <tr data-member-id="${member.id}">
                        <td>
                            <div class="member-name">${member.firstName} ${
            member.lastName
          }</div>
                        </td>
                        <td>
                            <div class="member-apa">${
                              member.apaNumber || "N/A"
                            }</div>
                        </td>
                        <td>
                            ${
                              canEdit && !isCurrentUser
                                ? `
                                <select class="role-select" data-member-id="${
                                  member.id
                                }" data-current-role="${member.role}">
                                    <option value="player" ${
                                      member.role === "player" ? "selected" : ""
                                    }>Player</option>
                                    <option value="captain" ${
                                      member.role === "captain"
                                        ? "selected"
                                        : ""
                                    }>Captain</option>
                                    <option value="manager" ${
                                      member.role === "manager"
                                        ? "selected"
                                        : ""
                                    }>Manager</option>
                                </select>
                            `
                                : `
                                <span class="role-badge role-${member.role.toLowerCase()}">${this.formatRole(
                                    member.role
                                  )}</span>
                            `
                            }
                        </td>
                        <td>
                            ${
                              canEdit
                                ? `
                                <div class="skill-level editable">
                                    <select class="skill-select" data-member-id="${
                                      member.id
                                    }" data-current-skill="${
                                    member.skillLevel
                                  }">
                                        <option value="">N/A</option>
                                        <option value="2" ${
                                          member.skillLevel == 2
                                            ? "selected"
                                            : ""
                                        }>2</option>
                                        <option value="3" ${
                                          member.skillLevel == 3
                                            ? "selected"
                                            : ""
                                        }>3</option>
                                        <option value="4" ${
                                          member.skillLevel == 4
                                            ? "selected"
                                            : ""
                                        }>4</option>
                                        <option value="5" ${
                                          member.skillLevel == 5
                                            ? "selected"
                                            : ""
                                        }>5</option>
                                        <option value="6" ${
                                          member.skillLevel == 6
                                            ? "selected"
                                            : ""
                                        }>6</option>
                                        <option value="7" ${
                                          member.skillLevel == 7
                                            ? "selected"
                                            : ""
                                        }>7</option>
                                        <option value="8" ${
                                          member.skillLevel == 8
                                            ? "selected"
                                            : ""
                                        }>8</option>
                                        <option value="9" ${
                                          member.skillLevel == 9
                                            ? "selected"
                                            : ""
                                        }>9</option>
                                    </select>
                                </div>
                            `
                                : `
                                <span class="skill-level">${
                                  member.skillLevel || "N/A"
                                }</span>
                            `
                            }
                        </td>
                        <td>
                            <span class="status-badge ${
                              member.active ? "active" : "inactive"
                            }">
                                ${member.active ? "Active" : "Inactive"}
                            </span>
                        </td>
                        <td>
                            <div class="member-actions">
                                ${
                                  canEdit && !isCurrentUser
                                    ? `
                                    <button class="btn btn-danger btn-sm remove-member-btn" 
                                            data-member-id="${member.id}" 
                                            data-member-name="${member.firstName} ${member.lastName}">
                                        Remove
                                    </button>
                                `
                                    : ""
                                }
                            </div>
                        </td>
                    </tr>
                `;
        }

        attachMemberEventListeners() {
          // Role change listeners
          document.querySelectorAll(".role-select").forEach((select) => {
            select.addEventListener("change", this.handleUpdateMemberRole);
          });

          // Skill level change listeners
          document.querySelectorAll(".skill-select").forEach((select) => {
            select.addEventListener("change", this.handleUpdateMemberSkill);
          });

          // Remove member listeners
          document.querySelectorAll(".remove-member-btn").forEach((btn) => {
            btn.addEventListener("click", this.handleRemoveMember);
          });
        }

        async handleUpdateMemberSkill(event) {
          const select = event.target;
          const memberId = select.dataset.memberId;
          const newSkillLevel = select.value;
          const currentSkillLevel = select.dataset.currentSkill;

          if (newSkillLevel === currentSkillLevel) return;

          try {
            const member = this.teamMembers.find((m) => m.id === memberId);
            if (!member) return;

            const updateData = {
              id: member.id,
              playerId: member.playerId,
              teamId: member.teamId,
              role: member.role,
              active: member.active,
              skillLevel_9b: newSkillLevel ? parseInt(newSkillLevel) : null,
              joinedAt: member.joinedAt,
              leftAt: member.leftAt,
            };

            const response = await this.authManager.apiRequest(
              `/teams/${this.authManager.activeTeamId}/memberships/${memberId}`,
              {
                method: "PUT",
                body: JSON.stringify(updateData),
              }
            );

            if (response.ok) {
              const skillDisplay = newSkillLevel
                ? `skill level ${newSkillLevel}`
                : "no skill level";
              this.showSuccess(
                `Updated ${member.firstName} ${member.lastName}'s ${skillDisplay}`
              );
              select.dataset.currentSkill = newSkillLevel; // Update the current value

              // Update the local data
              member.skillLevel = newSkillLevel
                ? parseInt(newSkillLevel)
                : null;
            } else {
              throw new Error("Failed to update member skill level");
            }
          } catch (error) {
            console.error("Failed to update member skill level:", error);
            this.showError("Failed to update skill level. Please try again.");
            select.value = currentSkillLevel; // Reset to previous value
          }
        }

        async handleUpdateMemberRole(event) {
          const select = event.target;
          const memberId = select.dataset.memberId;
          const newRole = select.value;
          const currentRole = select.dataset.currentRole;

          if (newRole === currentRole) return;

          try {
            const member = this.teamMembers.find((m) => m.id === memberId);
            if (!member) return;

            const updateData = {
              id: member.id,
              playerId: member.playerId,
              teamId: member.teamId,
              role: newRole,
              active: member.active,
              skillLevel_9b: member.skillLevel_9b,
              joinedAt: member.joinedAt,
              leftAt: member.leftAt,
            };

            const response = await this.authManager.apiRequest(
              `/teams/${this.authManager.activeTeamId}/memberships/${memberId}`,
              {
                method: "PUT",
                body: JSON.stringify(updateData),
              }
            );

            if (response.ok) {
              this.showSuccess(
                `Updated ${member.firstName} ${
                  member.lastName
                }'s role to ${this.formatRole(newRole)}`
              );
              await this.loadTeamMembers(); // Refresh the list
            } else {
              throw new Error("Failed to update member role");
            }
          } catch (error) {
            console.error("Failed to update member role:", error);
            this.showError("Failed to update member role. Please try again.");
            select.value = currentRole; // Reset to previous value
          }
        }

        async handleRemoveMember(event) {
          const btn = event.target;
          const memberId = btn.dataset.memberId;
          const memberName = btn.dataset.memberName;

          if (
            !confirm(
              `Are you sure you want to remove ${memberName} from the team?`
            )
          ) {
            return;
          }

          try {
            const response = await this.authManager.apiRequest(
              `/teams/${this.authManager.activeTeamId}/memberships/${memberId}`,
              { method: "DELETE" }
            );

            if (response.ok) {
              this.showSuccess(`Removed ${memberName} from the team`);
              await this.loadTeamMembers(); // Refresh the list
            } else {
              throw new Error("Failed to remove member");
            }
          } catch (error) {
            console.error("Failed to remove member:", error);
            this.showError("Failed to remove team member. Please try again.");
          }
        }

        showAddMemberForm() {
          // Check if we have players to search
          if (!this.allPlayers || this.allPlayers.length === 0) {
            this.showError(
              "Player search is not available. Please contact an administrator to add players to your team."
            );
            return;
          }

          document.getElementById("add-member-form").classList.add("show");
          document.getElementById("player-search").focus();
        }

        hideAddMemberForm() {
          document.getElementById("add-member-form").classList.remove("show");
          document.getElementById("add-member-form-element").reset();
          document.getElementById("search-results").classList.remove("show");
          this.selectedPlayer = null;
        }

        handlePlayerSearch(event) {
          const query = event.target.value.trim().toLowerCase();
          const searchResults = document.getElementById("search-results");

          if (query.length < 2) {
            searchResults.classList.remove("show");
            return;
          }

          // If no players loaded, show message
          if (!this.allPlayers || this.allPlayers.length === 0) {
            searchResults.innerHTML =
              '<div class="search-result-item">Player search not available. Please contact an administrator to add players.</div>';
            searchResults.classList.add("show");
            return;
          }

          const filteredPlayers = this.allPlayers.filter((player) => {
            const name = `${player.firstName} ${player.lastName}`.toLowerCase();
            const apaNumber = (player.apaNumber || "").toString();

            // Exclude players already on the team
            const isAlreadyMember = this.teamMembers.some(
              (member) => member.playerId === player.id
            );

            return (
              !isAlreadyMember &&
              (name.includes(query) || apaNumber.includes(query))
            );
          });

          this.renderSearchResults(filteredPlayers);
        }

        renderSearchResults(players) {
          const searchResults = document.getElementById("search-results");

          if (players.length === 0) {
            searchResults.innerHTML =
              '<div class="search-result-item">No players found</div>';
          } else {
            searchResults.innerHTML = players
              .map(
                (player) => `
                        <div class="search-result-item" data-player-id="${
                          player.id
                        }">
                            <div class="search-result-name">${
                              player.firstName
                            } ${player.lastName}</div>
                            <div class="search-result-info">
                                APA: ${player.apaNumber || "N/A"} | 
                                Skill: ${player.skillLevel || "N/A"}
                            </div>
                        </div>
                    `
              )
              .join("");

            // Add click listeners
            searchResults
              .querySelectorAll(".search-result-item")
              .forEach((item) => {
                item.addEventListener("click", () => {
                  const playerId = item.dataset.playerId;
                  this.selectedPlayer = players.find((p) => p.id === playerId);

                  const searchInput = document.getElementById("player-search");
                  searchInput.value = `${this.selectedPlayer.firstName} ${this.selectedPlayer.lastName}`;
                  searchResults.classList.remove("show");
                });
              });
          }

          searchResults.classList.add("show");
        }

        async handleAddMember(event) {
          event.preventDefault();

          if (!this.selectedPlayer) {
            this.showError("Please select a player from the search results.");
            return;
          }

          const role = document.getElementById("member-role").value;

          try {
            const membershipData = {
              playerId: this.selectedPlayer.id,
              teamId: this.authManager.activeTeamId,
              role: role,
              active: true,
            };

            const response = await this.authManager.apiRequest(
              `/teams/${this.authManager.activeTeamId}/memberships`,
              {
                method: "POST",
                body: JSON.stringify(membershipData),
              }
            );

            if (response.ok) {
              this.showSuccess(
                `Added ${this.selectedPlayer.firstName} ${
                  this.selectedPlayer.lastName
                } to the team as ${this.formatRole(role)}`
              );
              this.hideAddMemberForm();
              await this.loadTeamMembers(); // Refresh the list
            } else {
              throw new Error("Failed to add member");
            }
          } catch (error) {
            console.error("Failed to add member:", error);
            this.showError("Failed to add team member. Please try again.");
          }
        }

        formatRole(role) {
          const roleMap = {
            player: "Player",
            captain: "Captain",
            manager: "Manager",
          };
          return roleMap[role.toLowerCase()] || role;
        }

        showSuccess(message) {
          const errorElement = document.getElementById("error-message");
          errorElement.className = "success";
          errorElement.textContent = message;
          errorElement.style.display = "block";

          setTimeout(() => {
            errorElement.style.display = "none";
          }, 5000);
        }

        showError(message) {
          const errorElement = document.getElementById("error-message");
          errorElement.className = "error";
          errorElement.textContent = message;
          errorElement.style.display = "block";
        }

        hideLoading() {
          document.getElementById("loading").style.display = "none";
        }

        showMainContent() {
          document.getElementById("main-content").style.display = "block";
          document.getElementById("no-team").style.display = "none";
          document.getElementById("permission-denied").style.display = "none";
        }

        showNoTeam() {
          document.getElementById("main-content").style.display = "none";
          document.getElementById("no-team").style.display = "block";
          document.getElementById("permission-denied").style.display = "none";
        }

        showPermissionDenied() {
          document.getElementById("main-content").style.display = "none";
          document.getElementById("no-team").style.display = "none";
          document.getElementById("permission-denied").style.display = "block";
        }

        // Session Management Methods
        async loadSessions() {
          try {
            const currentMembership = this.authManager.getActiveMembership();
            if (!currentMembership?.divisionId) {
              document.getElementById("sessions-list").innerHTML =
                "<p>No division selected.</p>";
              return;
            }

            const response = await this.authManager.apiRequest(
              `/divisions/${currentMembership.divisionId}/sessions`
            );

            if (response.ok) {
              this.sessions = await response.json();
              await this.renderSessionsList();
            } else {
              throw new Error("Failed to load sessions");
            }
          } catch (error) {
            console.error("Failed to load sessions:", error);
            document.getElementById("sessions-list").innerHTML =
              "<p>Failed to load sessions. Please try again.</p>";
          }
        }

        async renderSessionsList() {
          const sessionsListElement = document.getElementById("sessions-list");

          if (this.sessions.length === 0) {
            sessionsListElement.innerHTML =
              '<p>No sessions found. Use the "Create Session" button to add a new session/season.</p>';
            return;
          }

          // Sort sessions by start date (newest first)
          const sortedSessions = [...this.sessions].sort(
            (a, b) => new Date(b.startDate) - new Date(a.startDate)
          );

          // Get match counts for each session
          const currentMembership = this.authManager.getActiveMembership();
          const matchCounts = {};

          for (const session of sortedSessions) {
            try {
              const response = await this.authManager.apiRequest(
                `/GetMatches?divisionId=${currentMembership.divisionId}`
              );
              if (response.ok) {
                const matches = await response.json();
                matchCounts[session.id] = matches.filter(
                  (m) => m.sessionId === session.id
                ).length;
              } else {
                matchCounts[session.id] = 0;
              }
            } catch (error) {
              matchCounts[session.id] = 0;
            }
          }

          sessionsListElement.innerHTML = sortedSessions
            .map((session) => {
              const startDate = new Date(
                session.startDate
              ).toLocaleDateString();
              const endDate = new Date(session.endDate).toLocaleDateString();
              const activeClass = session.isActive ? "active" : "";
              const badgeClass = session.isActive ? "active" : "inactive";
              const badgeText = session.isActive ? "Active" : "Inactive";
              const matchCount = matchCounts[session.id] || 0;
              const canDelete = matchCount === 0;

              return `
              <div class="session-card ${activeClass}">
                <div class="session-info">
                  <div class="session-name">${this.escapeHtml(
                    session.name
                  )}</div>
                  <div class="session-dates">${startDate} - ${endDate}</div>
                  <div class="session-meta">
                    <span class="session-badge ${badgeClass}">${badgeText}</span>
                    <span class="session-match-count">${matchCount} match${
                matchCount !== 1 ? "es" : ""
              }</span>
                  </div>
                </div>
                <div class="session-actions">
                  <button 
                    class="btn ${
                      session.isActive ? "btn-secondary" : "btn-primary"
                    } btn-sm"
                    onclick="teamAdminApp.handleToggleSessionActive('${
                      session.id
                    }', ${!session.isActive})"
                    title="${session.isActive ? "Deactivate" : "Activate"}"
                  >
                    ${session.isActive ? "⏸️ Deactivate" : "▶️ Activate"}
                  </button>
                  <button 
                    class="btn btn-secondary btn-sm"
                    onclick="teamAdminApp.handleEditSession('${session.id}')"
                    title="Edit"
                  >
                    ✏️ Edit
                  </button>
                  <button 
                    class="btn btn-danger btn-sm"
                    onclick="teamAdminApp.handleDeleteSession('${session.id}')"
                    ${canDelete ? "" : "disabled"}
                    title="${
                      canDelete
                        ? "Delete"
                        : "Cannot delete session with matches"
                    }"
                  >
                    🗑️ Delete
                  </button>
                </div>
              </div>
            `;
            })
            .join("");
        }

        showSessionModal() {
          this.editingSessionId = null;
          document.getElementById("session-modal-title").textContent =
            "Create Session";
          document.getElementById("session-name").value = "";
          document.getElementById("session-start-date").value = "";
          document.getElementById("session-end-date").value = "";
          document.getElementById("session-is-active").checked = true;
          document.getElementById("session-modal").style.display = "flex";
        }

        hideSessionModal() {
          document.getElementById("session-modal").style.display = "none";
          this.editingSessionId = null;
        }

        async handleEditSession(sessionId) {
          const session = this.sessions.find((s) => s.id === sessionId);
          if (!session) return;

          this.editingSessionId = sessionId;
          document.getElementById("session-modal-title").textContent =
            "Edit Session";
          document.getElementById("session-name").value = session.name;
          document.getElementById("session-start-date").value = new Date(
            session.startDate
          )
            .toISOString()
            .split("T")[0];
          document.getElementById("session-end-date").value = new Date(
            session.endDate
          )
            .toISOString()
            .split("T")[0];
          document.getElementById("session-is-active").checked =
            session.isActive;
          document.getElementById("session-modal").style.display = "flex";
        }

        async handleSaveSession(event) {
          event.preventDefault();

          const currentMembership = this.authManager.getActiveMembership();
          if (!currentMembership?.divisionId) {
            alert("No division selected.");
            return;
          }

          const sessionData = {
            divisionId: currentMembership.divisionId,
            name: document.getElementById("session-name").value,
            startDate: new Date(
              document.getElementById("session-start-date").value
            ).toISOString(),
            endDate: new Date(
              document.getElementById("session-end-date").value
            ).toISOString(),
            isActive: document.getElementById("session-is-active").checked,
          };

          try {
            let response;
            if (this.editingSessionId) {
              // Update existing session
              response = await this.authManager.apiRequest(
                `/divisions/${currentMembership.divisionId}/sessions/${this.editingSessionId}`,
                {
                  method: "PUT",
                  body: JSON.stringify(sessionData),
                }
              );
            } else {
              // Create new session
              response = await this.authManager.apiRequest(
                `/divisions/${currentMembership.divisionId}/sessions`,
                {
                  method: "POST",
                  body: JSON.stringify(sessionData),
                }
              );
            }

            if (response.ok) {
              this.hideSessionModal();
              await this.loadSessions();
              alert(
                this.editingSessionId
                  ? "Session updated successfully!"
                  : "Session created successfully!"
              );
            } else {
              const errorText = await response.text();
              throw new Error(errorText || "Failed to save session");
            }
          } catch (error) {
            console.error("Failed to save session:", error);
            alert(`Failed to save session: ${error.message}`);
          }
        }

        async handleToggleSessionActive(sessionId, newActiveState) {
          const session = this.sessions.find((s) => s.id === sessionId);
          if (!session) return;

          const currentMembership = this.authManager.getActiveMembership();
          if (!currentMembership?.divisionId) return;

          const sessionData = {
            ...session,
            isActive: newActiveState,
          };

          try {
            const response = await this.authManager.apiRequest(
              `/divisions/${currentMembership.divisionId}/sessions/${sessionId}`,
              {
                method: "PUT",
                body: JSON.stringify(sessionData),
              }
            );

            if (response.ok) {
              await this.loadSessions();
            } else {
              const errorText = await response.text();
              throw new Error(errorText || "Failed to update session");
            }
          } catch (error) {
            console.error("Failed to toggle session active state:", error);
            alert(`Failed to update session: ${error.message}`);
          }
        }

        async handleDeleteSession(sessionId) {
          if (
            !confirm(
              "Are you sure you want to delete this session? This action cannot be undone."
            )
          ) {
            return;
          }

          const currentMembership = this.authManager.getActiveMembership();
          if (!currentMembership?.divisionId) return;

          try {
            const response = await this.authManager.apiRequest(
              `/divisions/${currentMembership.divisionId}/sessions/${sessionId}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok || response.status === 204) {
              await this.loadSessions();
              alert("Session deleted successfully!");
            } else {
              const errorText = await response.text();
              throw new Error(errorText || "Failed to delete session");
            }
          } catch (error) {
            console.error("Failed to delete session:", error);
            alert(`Failed to delete session: ${error.message}`);
          }
        }

        escapeHtml(text) {
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          };
          return text.replace(/[&<>"']/g, (m) => map[m]);
        }
      }

      // Initialize the app when DOM is loaded
      let teamAdminApp;
      document.addEventListener("DOMContentLoaded", () => {
        teamAdminApp = new TeamAdminApp();
        teamAdminApp.initialize();
      });
    </script>
  </body>
</html>
