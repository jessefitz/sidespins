# SideSpins Authentication JWT Flow Documentation

## Overview

SideSpins implements a **two-stage JWT authentication system** that combines Stytch's secure authentication with our own performance-optimized session management. This document details the complete authentication flow, JWT validation process, and ongoing session verification.

## Authentication Architecture

### Two-Stage JWT System

**Stage 1: Stytch Session JWT (Bootstrap)**
- Short-lived JWT from Stytch
- Used only during initial authentication
- Validated against Stytch API once per authentication session
- Contains user identity and session information

**Stage 2: App JWT (Ongoing)**
- Long-lived JWT generated by our backend
- Used for all subsequent API calls
- Validated locally using our signing key
- Contains team metadata and role information

## SMS Authentication Flow

### Step 1: Send SMS Code

**Frontend (`docs/auth-test.html`):**
```javascript
// User enters phone number, frontend calls:
const result = await authManager.sendSmsCode(phoneNumber);
```

**Backend API Call:**
- **Endpoint:** `SendSmsCode` function in `AuthFunctions.cs`
- **Input:** Phone number (E.164 format)
- **Process:** Calls `AuthService.SendSmsCodeAsync()`

**Stytch API Call:**
```http
POST https://test.stytch.com/v1/otps/sms/send
Authorization: Basic {base64(project_id:secret)}
Content-Type: application/json

{
  "phone_number": "+1234567890"
}
```

**Response:**
- Returns `phone_id` for verification step
- Frontend displays success message with phone ID

### Step 2: Verify SMS Code

**Frontend:**
```javascript
// User enters 6-digit code, frontend validates and calls:
const result = await authManager.verifySmsCode(code);
```

**Backend API Call:**
- **Endpoint:** `VerifySmsCode` function in `AuthFunctions.cs`
- **Input:** SMS code (6 digits) and stored phone_id
- **Process:** Calls `AuthService.VerifySmsCodeAsync()`

**Stytch API Call:**
```http
POST https://test.stytch.com/v1/otps/sms/authenticate
Authorization: Basic {base64(project_id:secret)}
Content-Type: application/json

{
  "phone_id": "phone-test-123...",
  "code": "123456"
}
```

**Stytch Response:**
```json
{
  "session_jwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9...",
  "user_id": "user-test-123...",
  "status_code": 200
}
```

### Step 3: Session Bootstrap (Critical Phase)

**Backend Process (`AuthService.ValidateStytchSessionAsync()`):**

1. **Validate Stytch Session JWT:**
   ```http
   POST https://test.stytch.com/v1/sessions/authenticate
   Authorization: Basic {base64(project_id:secret)}
   
   {
     "session_jwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9..."
   }
   ```

2. **Retrieve User Details:**
   ```http
   GET https://test.stytch.com/v1/users/{user_id}
   Authorization: Basic {base64(project_id:secret)}
   ```

3. **Extract Trusted Metadata:**
   ```json
   {
     "user": {
       "trusted_metadata": {
         "teams": {
           "team": {
             "team_id": "break_of_dawn_9b",
             "team_role": "manager"
           }
         }
       }
     }
   }
   ```

4. **Generate App JWT:**
   ```csharp
   var claims = new AppClaims
   {
       Sub = sessionResponse.Session.UserId,
       TeamId = trustedMetadata.Teams.Team.TeamId,
       TeamRole = trustedMetadata.Teams.Team.TeamRole,
       Iat = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
       Exp = DateTimeOffset.UtcNow.AddMinutes(60).ToUnixTimeSeconds(),
   };
   
   return GenerateAppJwt(claims);
   ```

**Frontend Result:**
- Receives App JWT
- Stores in secure storage (HttpOnly cookie or localStorage)
- Calls `checkAuthStatus()` to verify authentication state

## Post-Authentication: Ongoing Session Verification

### App JWT Validation (`AuthService.ValidateAppJwt()`)

**Used for:** Every protected API endpoint call

**Process:**
1. **Extract JWT** from request headers/cookies
2. **Local Validation** using our signing key:
   ```csharp
   var tokenHandler = new JwtSecurityTokenHandler();
   var key = Encoding.ASCII.GetBytes(_jwtSigningKey);
   
   // Validate signature, expiration, and claims
   var validationParameters = new TokenValidationParameters
   {
       ValidateIssuerSigningKey = true,
       IssuerSigningKey = new SymmetricSecurityKey(key),
       ValidateIssuer = false,
       ValidateAudience = false,
       ClockSkew = TimeSpan.Zero
   };
   ```

3. **Extract Claims:**
   - `sub` (user ID)
   - `team_id` (team identifier)
   - `team_role` (permission level)
   - `iat` (issued at)
   - `exp` (expiration)

4. **Authorization Check:**
   - Verify user has access to requested team resources
   - Check role permissions for the requested operation

### Performance Benefits

**No External API Calls:**
- App JWT validation is entirely local
- No dependency on Stytch availability
- Sub-millisecond validation time

**Reduced Costs:**
- Stytch API only called during initial authentication
- Thousands of requests handled with single authentication

**Improved Reliability:**
- System remains functional even during Stytch outages
- Session management under full control

## JWT Claims Structure

### Stytch Session JWT (Temporary)
```json
{
  "iss": "stytch.com",
  "sub": "user-test-123...",
  "aud": ["project-test-123..."],
  "exp": 1693920000,
  "iat": 1693916400,
  "session_id": "session-test-123..."
}
```

### App JWT (Primary)
```json
{
  "sub": "user-test-123...",
  "team_id": "break_of_dawn_9b",
  "team_role": "manager",
  "iat": 1693916400,
  "exp": 1693920000
}
```

## Security Considerations

### JWT Signing Keys
- **App JWT Key:** Stored in Azure Key Vault or secure configuration
- **Rotation:** Implement key rotation strategy for long-term security
- **Algorithm:** HMAC SHA-256 for symmetric signing

### Session Management
- **Expiration:** App JWTs expire after 60 minutes by default
- **Refresh:** Implement refresh token or re-authentication flow
- **Revocation:** Consider implementing JWT blacklist for immediate revocation

### Team Authorization
- **Scope Enforcement:** Users can only access their assigned team data
- **Role Validation:** Each API endpoint validates required role level
- **Metadata Trust:** Trusted metadata in Stytch ensures authoritative team assignments

## API Endpoint Authentication Pattern

### Protected Endpoint Example
```csharp
[Function("GetTeamData")]
public async Task<IActionResult> GetTeamData(
    [HttpTrigger(AuthorizationLevel.Anonymous, "get", Route = "teams/{teamId}")] 
    HttpRequest req,
    string teamId)
{
    // 1. Extract JWT from request
    var jwt = ExtractJwtFromRequest(req);
    
    // 2. Validate App JWT locally
    var (isValid, claims) = _authService.ValidateAppJwt(jwt);
    
    if (!isValid || claims == null)
        return new UnauthorizedResult();
    
    // 3. Check team authorization
    if (claims.TeamId != teamId)
        return new ForbiddenResult();
    
    // 4. Check role permissions
    if (!HasRequiredRole(claims.TeamRole, RequiredRole.Player))
        return new ForbiddenResult();
    
    // 5. Process authorized request
    return await ProcessTeamDataRequest(teamId);
}
```

## Magic Link Authentication Flow

### Similar Pattern with Different Stytch Endpoints

**Send Magic Link:**
```http
POST https://test.stytch.com/v1/magic_links/email/send
```

**Authenticate Magic Link:**
```http
POST https://test.stytch.com/v1/magic_links/authenticate
```

**Same Bootstrap Process:**
- Validate Stytch session JWT once
- Extract user details and trusted metadata
- Generate App JWT for ongoing use

## Frontend Authentication State Management

### AuthManager Class (`assets/auth.js`)
```javascript
class AuthManager {
  // Check authentication status
  async checkAuth() {
    // Validates App JWT locally or with backend
  }
  
  // SMS authentication
  async sendSmsCode(phoneNumber) { /* ... */ }
  async verifySmsCode(code) { /* ... */ }
  
  // Magic link authentication  
  async sendMagicLink(email) { /* ... */ }
  async authenticateToken(token) { /* ... */ }
  
  // Session management
  getCurrentUser() { /* Returns claims from App JWT */ }
  logout() { /* Clears stored JWT */ }
}
```

## Testing and Debugging

### Test Page (`docs/auth-test.html`)
- **SMS Flow Testing:** Send and verify SMS codes
- **Magic Link Testing:** Send and authenticate magic links
- **Session Status:** Check current authentication state
- **Error Handling:** Display detailed error messages

### Key Validation Points
1. **Phone Number Format:** E.164 validation before sending SMS
2. **Code Format:** 6-digit validation before verification
3. **JWT Expiration:** Handle expired App JWTs gracefully
4. **Team Authorization:** Verify team access on every request
5. **Role Permissions:** Check role requirements per endpoint

## Troubleshooting Common Issues

### Authentication Failures
- **Invalid Stytch Credentials:** Check project ID and secret key
- **JWT Signing Key Mismatch:** Ensure consistent key across all functions
- **Expired Sessions:** Implement proper refresh or re-authentication flow
- **Missing Team Metadata:** Verify trusted metadata is set in Stytch

### Performance Issues
- **Slow Authentication:** Check Stytch API response times
- **High Latency:** Ensure App JWT validation is local-only
- **Memory Usage:** Monitor JWT parsing and validation efficiency

## Configuration Requirements

### Environment Variables
```
STYTCH_PROJECT_ID=project-test-123...
STYTCH_SECRET=secret-test-123...
JWT_SIGNING_KEY=your-256-bit-secret-key
STYTCH_ENVIRONMENT=test  # or live
```

### Stytch Configuration
- **SMS Templates:** Configure branded SMS messages
- **Magic Link Templates:** Set up email templates and redirect URLs
- **Session Settings:** Configure session duration and security policies
- **Trusted Metadata Schema:** Define team structure in Stytch dashboard

---

*This document should be kept up-to-date as the authentication system evolves. Last updated: September 6, 2025*
