<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - SideSpins</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        line-height: 1.6;
      }

      .header {
        background: white;
        border-bottom: 1px solid #e1e5e9;
        padding: 1rem 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007cba;
      }

      .nav-links {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-links a {
        color: #666;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: background-color 0.2s;
      }

      .nav-links a:hover {
        background-color: #f8f9fa;
      }

      .nav-links a.active {
        background-color: #007cba;
        color: white;
      }

      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .page-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
      }

      .page-title h1 {
        margin: 0;
        color: #333;
      }

      .admin-badge {
        background: #dc3545;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .admin-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e1e5e9;
      }

      .section-title {
        margin: 0;
        font-size: 1.25rem;
        color: #333;
      }

      .division-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .division-selector label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
      }

      .division-select {
        padding: 0.5rem 1rem;
        border: 1px solid #e1e5e9;
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
        min-width: 200px;
      }

      .division-select:focus {
        outline: none;
        border-color: #007cba;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background-color: #007cba;
        color: white;
      }

      .btn-primary:hover {
        background-color: #006699;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
      }

      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background-color: #c82333;
      }

      .btn-danger:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }

      /* Session Management Styles */
      .session-card {
        background: #f8f9fa;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
      }

      .session-card:hover {
        border-color: #007cba;
      }

      .session-card.active {
        background: #e7f5ff;
        border-color: #007cba;
      }

      .session-info {
        flex: 1;
      }

      .session-name {
        font-weight: 600;
        font-size: 1rem;
        color: #333;
        margin-bottom: 0.25rem;
      }

      .session-dates {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.5rem;
      }

      .session-meta {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .session-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .session-badge.active {
        background: #d4edda;
        color: #155724;
      }

      .session-badge.inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .session-match-count {
        font-size: 0.85rem;
        color: #666;
      }

      .session-actions {
        display: flex;
        gap: 0.5rem;
      }

      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .modal-content h3 {
        margin: 0 0 1.5rem 0;
        color: #333;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
      }

      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e1e5e9;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
      }

      .form-control:focus {
        outline: none;
        border-color: #007cba;
      }

      .form-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
      }

      /* Access Denied */
      .access-denied {
        text-align: center;
        padding: 4rem 2rem;
      }

      .access-denied h2 {
        color: #dc3545;
        margin-bottom: 1rem;
      }

      .access-denied p {
        color: #666;
        margin-bottom: 1.5rem;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <a href="/app.html" class="logo">üé± SideSpins</a>
        <nav class="nav-links">
          <a href="/app.html">Dashboard</a>
          <a href="/schedule-new.html?v=2">Schedule</a>
          <a href="/lineup-explorer-new.html?v=2">Lineup Explorer</a>
          <a href="/admin.html" class="active">Admin</a>
        </nav>
      </div>
    </header>

    <main class="main-content">
      <div id="loading-state" class="loading">
        <p>Loading...</p>
      </div>

      <div id="access-denied" class="access-denied" style="display: none">
        <h2>üö´ Access Denied</h2>
        <p>You do not have admin privileges to access this page.</p>
        <a href="/app.html" class="btn btn-primary">Return to Dashboard</a>
      </div>

      <div id="admin-content" style="display: none">
        <div class="page-title">
          <h1>Admin Dashboard</h1>
          <span class="admin-badge">Admin Only</span>
        </div>

        <!-- Division Selector -->
        <div class="admin-section">
          <div class="division-selector">
            <label for="division-select">Division:</label>
            <select id="division-select" class="division-select">
              <option value="">Select a division...</option>
            </select>
          </div>
        </div>

        <!-- Sessions Section -->
        <div class="admin-section" id="sessions-section" style="display: none">
          <div class="section-header">
            <h2 class="section-title">üìÖ Session Management</h2>
            <button id="add-session-btn" class="btn btn-primary">
              <span>‚ûï</span> Create Session
            </button>
          </div>

          <div id="sessions-list">
            <p class="loading">Loading sessions...</p>
          </div>

          <!-- Session Modal -->
          <div id="session-modal" class="modal" style="display: none">
            <div class="modal-content">
              <h3 id="session-modal-title">Create Session</h3>
              <form id="session-form">
                <div class="form-group">
                  <label for="session-name">Session Name *</label>
                  <input
                    type="text"
                    id="session-name"
                    class="form-control"
                    placeholder="e.g., Fall 2025, Winter 2026"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="session-start-date">Start Date *</label>
                  <input
                    type="date"
                    id="session-start-date"
                    class="form-control"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="session-end-date">End Date *</label>
                  <input
                    type="date"
                    id="session-end-date"
                    class="form-control"
                    required
                  />
                </div>

                <div class="form-group">
                  <label>
                    <input
                      type="checkbox"
                      id="session-is-active"
                      style="margin-right: 0.5rem"
                    />
                    Active
                  </label>
                </div>

                <div class="form-actions">
                  <button
                    type="button"
                    id="cancel-session-btn"
                    class="btn btn-secondary"
                  >
                    Cancel
                  </button>
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="/assets/auth.js?v=202601250900"></script>
    <script>
      class AdminDashboard {
        constructor() {
          this.authManager = new AuthManager();
          this.currentDivisionId = null;
          this.sessions = [];
          this.editingSessionId = null;
        }

        async initialize() {
          try {
            // Check authentication
            const isAuthenticated = await this.authManager.requireAuth(
              "/login-new.html?redirect=/admin.html",
            );
            if (!isAuthenticated) return;

            // Load user data to check role
            await this.authManager.loadUserMemberships();

            // Check if user is global admin
            if (!this.authManager.isGlobalAdmin()) {
              document.getElementById("loading-state").style.display = "none";
              document.getElementById("access-denied").style.display = "block";
              return;
            }

            // Show admin content
            document.getElementById("loading-state").style.display = "none";
            document.getElementById("admin-content").style.display = "block";

            // Load divisions from user memberships
            this.loadDivisions();

            // Set up event listeners
            this.setupEventListeners();
          } catch (error) {
            console.error("Failed to initialize admin dashboard:", error);
            document.getElementById("loading-state").innerHTML =
              '<p style="color: red;">Failed to load admin dashboard. Please try again.</p>';
          }
        }

        loadDivisions() {
          const divisionSelect = document.getElementById("division-select");
          const memberships = this.authManager.userMemberships || [];

          // Get unique divisions from memberships
          const divisions = new Map();
          memberships.forEach((m) => {
            if (m.divisionId && !divisions.has(m.divisionId)) {
              divisions.set(m.divisionId, m.divisionName || m.divisionId);
            }
          });

          // Populate dropdown
          divisions.forEach((name, id) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name;
            divisionSelect.appendChild(option);
          });

          // Auto-select first division if available
          if (divisions.size > 0) {
            const firstDivisionId = divisions.keys().next().value;
            divisionSelect.value = firstDivisionId;
            this.handleDivisionChange(firstDivisionId);
          }
        }

        setupEventListeners() {
          // Division change
          document
            .getElementById("division-select")
            .addEventListener("change", (e) => {
              this.handleDivisionChange(e.target.value);
            });

          // Session modal
          document
            .getElementById("add-session-btn")
            .addEventListener("click", () => this.showSessionModal());
          document
            .getElementById("cancel-session-btn")
            .addEventListener("click", () => this.hideSessionModal());
          document
            .getElementById("session-form")
            .addEventListener("submit", (e) => this.handleSaveSession(e));

          // Close modal on backdrop click
          document
            .getElementById("session-modal")
            .addEventListener("click", (e) => {
              if (e.target.id === "session-modal") {
                this.hideSessionModal();
              }
            });
        }

        async handleDivisionChange(divisionId) {
          this.currentDivisionId = divisionId;

          if (!divisionId) {
            document.getElementById("sessions-section").style.display = "none";
            return;
          }

          document.getElementById("sessions-section").style.display = "block";
          await this.loadSessions();
        }

        async loadSessions() {
          if (!this.currentDivisionId) return;

          const sessionsListElement = document.getElementById("sessions-list");
          sessionsListElement.innerHTML =
            '<p class="loading">Loading sessions...</p>';

          try {
            const response = await this.authManager.makeAuthenticatedRequest(
              `${this.authManager.baseUrl}/divisions/${this.currentDivisionId}/sessions`,
              { method: "GET" },
            );

            if (!response.ok) {
              throw new Error("Failed to load sessions");
            }

            this.sessions = await response.json();

            // Get match counts for each session
            const matchResponse =
              await this.authManager.makeAuthenticatedRequest(
                `${this.authManager.baseUrl}/GetMatches?divisionId=${this.currentDivisionId}`,
                { method: "GET" },
              );

            let matchCounts = {};
            if (matchResponse.ok) {
              const matches = await matchResponse.json();
              matches.forEach((match) => {
                if (match.sessionId) {
                  matchCounts[match.sessionId] =
                    (matchCounts[match.sessionId] || 0) + 1;
                }
              });
            }

            this.renderSessionsList(matchCounts);
          } catch (error) {
            console.error("Failed to load sessions:", error);
            sessionsListElement.innerHTML =
              '<p style="color: red;">Failed to load sessions.</p>';
          }
        }

        renderSessionsList(matchCounts) {
          const sessionsListElement = document.getElementById("sessions-list");

          if (this.sessions.length === 0) {
            sessionsListElement.innerHTML =
              '<p class="empty-state">No sessions found. Create your first session to get started.</p>';
            return;
          }

          // Sort sessions by start date (newest first)
          const sortedSessions = [...this.sessions].sort(
            (a, b) => new Date(b.startDate) - new Date(a.startDate),
          );

          sessionsListElement.innerHTML = sortedSessions
            .map((session) => {
              const startDate = new Date(
                session.startDate,
              ).toLocaleDateString();
              const endDate = new Date(session.endDate).toLocaleDateString();
              const activeClass = session.isActive ? "active" : "";
              const badgeClass = session.isActive ? "active" : "inactive";
              const badgeText = session.isActive ? "Active" : "Inactive";
              const matchCount = matchCounts[session.id] || 0;
              const canDelete = matchCount === 0;

              return `
              <div class="session-card ${activeClass}">
                <div class="session-info">
                  <div class="session-name">${this.escapeHtml(session.name)}</div>
                  <div class="session-dates">${startDate} - ${endDate}</div>
                  <div class="session-meta">
                    <span class="session-badge ${badgeClass}">${badgeText}</span>
                    <span class="session-match-count">${matchCount} match${matchCount !== 1 ? "es" : ""}</span>
                  </div>
                </div>
                <div class="session-actions">
                  <button 
                    class="btn ${session.isActive ? "btn-secondary" : "btn-primary"} btn-sm"
                    onclick="adminDashboard.handleToggleSessionActive('${session.id}', ${!session.isActive})"
                    title="${session.isActive ? "Deactivate" : "Activate"}"
                  >
                    ${session.isActive ? "‚è∏Ô∏è Deactivate" : "‚ñ∂Ô∏è Activate"}
                  </button>
                  <button 
                    class="btn btn-secondary btn-sm"
                    onclick="adminDashboard.handleEditSession('${session.id}')"
                    title="Edit"
                  >
                    ‚úèÔ∏è Edit
                  </button>
                  <button 
                    class="btn btn-danger btn-sm"
                    onclick="adminDashboard.handleDeleteSession('${session.id}')"
                    ${canDelete ? "" : "disabled"}
                    title="${canDelete ? "Delete" : "Cannot delete session with matches"}"
                  >
                    üóëÔ∏è Delete
                  </button>
                </div>
              </div>
            `;
            })
            .join("");
        }

        showSessionModal() {
          this.editingSessionId = null;
          document.getElementById("session-modal-title").textContent =
            "Create Session";
          document.getElementById("session-name").value = "";
          document.getElementById("session-start-date").value = "";
          document.getElementById("session-end-date").value = "";
          document.getElementById("session-is-active").checked = true;
          document.getElementById("session-modal").style.display = "flex";
        }

        hideSessionModal() {
          document.getElementById("session-modal").style.display = "none";
          this.editingSessionId = null;
        }

        handleEditSession(sessionId) {
          const session = this.sessions.find((s) => s.id === sessionId);
          if (!session) return;

          this.editingSessionId = sessionId;
          document.getElementById("session-modal-title").textContent =
            "Edit Session";
          document.getElementById("session-name").value = session.name;
          document.getElementById("session-start-date").value = new Date(
            session.startDate,
          )
            .toISOString()
            .split("T")[0];
          document.getElementById("session-end-date").value = new Date(
            session.endDate,
          )
            .toISOString()
            .split("T")[0];
          document.getElementById("session-is-active").checked =
            session.isActive;
          document.getElementById("session-modal").style.display = "flex";
        }

        async handleSaveSession(event) {
          event.preventDefault();

          if (!this.currentDivisionId) {
            alert("Please select a division first.");
            return;
          }

          const sessionData = {
            divisionId: this.currentDivisionId,
            name: document.getElementById("session-name").value,
            startDate: new Date(
              document.getElementById("session-start-date").value,
            ).toISOString(),
            endDate: new Date(
              document.getElementById("session-end-date").value,
            ).toISOString(),
            isActive: document.getElementById("session-is-active").checked,
          };

          try {
            let response;
            if (this.editingSessionId) {
              // Update existing session
              response = await this.authManager.makeAuthenticatedRequest(
                `${this.authManager.baseUrl}/divisions/${this.currentDivisionId}/sessions/${this.editingSessionId}`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(sessionData),
                },
              );
            } else {
              // Create new session
              response = await this.authManager.makeAuthenticatedRequest(
                `${this.authManager.baseUrl}/divisions/${this.currentDivisionId}/sessions`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(sessionData),
                },
              );
            }

            if (response.ok) {
              this.hideSessionModal();
              await this.loadSessions();
              alert(
                this.editingSessionId
                  ? "Session updated successfully!"
                  : "Session created successfully!",
              );
            } else {
              const errorText = await response.text();
              throw new Error(errorText || "Failed to save session");
            }
          } catch (error) {
            console.error("Failed to save session:", error);
            alert(`Failed to save session: ${error.message}`);
          }
        }

        async handleToggleSessionActive(sessionId, newActiveState) {
          const session = this.sessions.find((s) => s.id === sessionId);
          if (!session) return;

          const sessionData = {
            ...session,
            isActive: newActiveState,
          };

          try {
            const response = await this.authManager.makeAuthenticatedRequest(
              `${this.authManager.baseUrl}/divisions/${this.currentDivisionId}/sessions/${sessionId}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(sessionData),
              },
            );

            if (response.ok) {
              await this.loadSessions();
            } else {
              const errorText = await response.text();
              throw new Error(errorText || "Failed to update session");
            }
          } catch (error) {
            console.error("Failed to toggle session active state:", error);
            alert(`Failed to update session: ${error.message}`);
          }
        }

        async handleDeleteSession(sessionId) {
          if (
            !confirm(
              "Are you sure you want to delete this session? This action cannot be undone.",
            )
          ) {
            return;
          }

          try {
            const response = await this.authManager.makeAuthenticatedRequest(
              `${this.authManager.baseUrl}/divisions/${this.currentDivisionId}/sessions/${sessionId}`,
              { method: "DELETE" },
            );

            if (response.ok || response.status === 204) {
              await this.loadSessions();
              alert("Session deleted successfully!");
            } else {
              const errorText = await response.text();
              throw new Error(errorText || "Failed to delete session");
            }
          } catch (error) {
            console.error("Failed to delete session:", error);
            alert(`Failed to delete session: ${error.message}`);
          }
        }

        escapeHtml(text) {
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          };
          return text.replace(/[&<>"']/g, (m) => map[m]);
        }
      }

      // Initialize the app
      let adminDashboard;
      document.addEventListener("DOMContentLoaded", () => {
        adminDashboard = new AdminDashboard();
        adminDashboard.initialize();
      });
    </script>
  </body>
</html>
