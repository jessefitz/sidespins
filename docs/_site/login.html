<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SideSpins</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        #auth-container {
            max-width: 400px;
            width: 100%;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #auth-container input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        #auth-container input:focus {
            outline: none;
            border-color: #007cba;
        }

        #auth-container button {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        #auth-container button:hover {
            background-color: #005a87;
        }

        #auth-container button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #auth-container label {
            display: block;
            margin-top: 1rem;
            font-weight: 600;
            color: #333;
        }

        #auth-container h1 {
            text-align: center;
            color: #333;
            margin-bottom: 2rem;
        }

        #auth-container h3 {
            color: #555;
            margin-bottom: 1rem;
        }

        .divider {
            margin: 2rem 0;
            border: none;
            border-top: 1px solid #e1e5e9;
        }

        #error-message, #success-message {
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            margin: 1rem 0;
            font-weight: 500;
        }

        #error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        #success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        #loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007cba;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-link {
            text-align: center;
            margin-top: 2rem;
        }

        .back-link a {
            color: #007cba;
            text-decoration: none;
        }

        .back-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
            <div id="loading" style="display:none;">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
            
            <div id="auth-form">
                <h1>Sign In to SideSpins</h1>
                
                <!-- APA-First Signup Flow -->
                <div id="signup-section">
                    <h3>League Member Sign In</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                        Only verified APA league members can create accounts. You'll need your APA member number.
                    </p>
                    
                    <div id="apa-input-section">
                        <label for="apa-number">APA Member Number:</label>
                        <input type="text" id="apa-number" placeholder="12345" />
                        
                        <label for="phone">Phone Number:</label>
                        <input type="tel" id="phone" placeholder="+1 (555) 123-4567" />
                        
                        <button id="signup-init-btn">Verify & Send Code</button>
                    </div>
                    
                    <div id="sms-code-section" style="display:none;">
                        <label for="sms-code">Enter the code sent to your phone:</label>
                        <input type="text" id="sms-code" placeholder="123456" maxlength="6" />
                        <button id="verify-sms-btn">Verify Code</button>
                        <button id="back-to-signup-btn" style="background-color: #6c757d;">Back</button>
                    </div>
                </div>
                
                <hr class="divider" />
                
                <!-- Existing Member Quick Sign In -->
                <div id="quick-signin-section">
                    <h3>Returning Member</h3>
                    <div id="phone-only-section">
                        <label for="phone-only">Phone Number:</label>
                        <input type="tel" id="phone-only" placeholder="+1 (555) 123-4567" />
                        <button id="send-quick-sms-btn">Send Code</button>
                    </div>
                    
                    <div id="quick-sms-code-section" style="display:none;">
                        <label for="quick-sms-code">Enter the code sent to your phone:</label>
                        <input type="text" id="quick-sms-code" placeholder="123456" maxlength="6" />
                        <button id="verify-quick-sms-btn">Verify Code</button>
                        <button id="back-to-phone-btn" style="background-color: #6c757d;">Back</button>
                    </div>
                </div>
            </div>
            
            <div id="error-message" style="display:none;"></div>
            <div id="success-message" style="display:none;"></div>
            
            <div class="back-link">
                <a href="/">‚Üê Back to SideSpins</a>
            </div>
        </div>
    </div>

    <script src="/assets/auth.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const authManager = new AuthManager();
        
        // Elements for APA-first signup
        const apaNumberInput = document.getElementById('apa-number');
        const phoneInput = document.getElementById('phone');
        const smsCodeInput = document.getElementById('sms-code');
        const signupInitBtn = document.getElementById('signup-init-btn');
        const verifySmsBtn = document.getElementById('verify-sms-btn');
        const backToSignupBtn = document.getElementById('back-to-signup-btn');
        const apaInputSection = document.getElementById('apa-input-section');
        const smsCodeSection = document.getElementById('sms-code-section');
        
        // Elements for quick sign in
        const phoneOnlyInput = document.getElementById('phone-only');
        const quickSmsCodeInput = document.getElementById('quick-sms-code');
        const sendQuickSmsBtn = document.getElementById('send-quick-sms-btn');
        const verifyQuickSmsBtn = document.getElementById('verify-quick-sms-btn');
        const backToPhoneBtn = document.getElementById('back-to-phone-btn');
        const phoneOnlySection = document.getElementById('phone-only-section');
        const quickSmsCodeSection = document.getElementById('quick-sms-code-section');
        
        // Common elements
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const loading = document.getElementById('loading');
        const authForm = document.getElementById('auth-form');
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }
        
        function showLoading() {
            loading.style.display = 'block';
            authForm.style.display = 'none';
        }
        
        function hideLoading() {
            loading.style.display = 'none';
            authForm.style.display = 'block';
        }
        
        function setButtonsEnabled(enabled) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = !enabled);
        }
        
        // Phone number formatting for both inputs
        [phoneInput, phoneOnlyInput].forEach(input => {
            if (input) {
                input.addEventListener('input', function(e) {
                    const formatted = authManager.formatPhoneNumber(e.target.value);
                    e.target.value = formatted;
                    
                    try {
                        e.target.dataset.cleanNumber = authManager.toE164(e.target.value);
                    } catch (error) {
                        e.target.dataset.cleanNumber = '';
                    }
                });
            }
        });
        
        // APA-first signup flow
        signupInitBtn.addEventListener('click', async function() {
            const apaNumber = apaNumberInput.value.trim();
            let formattedPhone;
            
            try {
                formattedPhone = phoneInput.dataset.cleanNumber || authManager.toE164(phoneInput.value);
            } catch (error) {
                showError('Please enter a valid phone number');
                return;
            }
            
            if (!apaNumber) {
                showError('Please enter your APA member number');
                return;
            }
            
            try {
                showLoading();
                setButtonsEnabled(false);
                
                const response = await authManager.signupInit(apaNumber, formattedPhone);
                
                if (response.success) {
                    // Store the response data for after verification
                    phoneInput.dataset.signupData = JSON.stringify(response);
                    
                    apaInputSection.style.display = 'none';
                    smsCodeSection.style.display = 'block';
                    showSuccess('Verification code sent to your phone!');
                } else {
                    showError(response.message || 'Signup failed. Please try again.');
                }
            } catch (error) {
                console.error('Signup init error:', error);
                showError('Signup failed. Please try again.');
            } finally {
                hideLoading();
                setButtonsEnabled(true);
            }
        });
        
        // Verify SMS for signup
        verifySmsBtn.addEventListener('click', async function() {
            const code = smsCodeInput.value.trim();
            const formattedPhone = phoneInput.dataset.cleanNumber;
            
            if (!code || code.length !== 6) {
                showError('Please enter the 6-digit code');
                return;
            }
            
            if (!formattedPhone) {
                showError('Phone number not found. Please try again.');
                return;
            }
            
            try {
                showLoading();
                setButtonsEnabled(false);
                
                const response = await authManager.verifySmsCode(formattedPhone, code);
                
                if (response.ok) {
                    // Get the stored signup data
                    const signupDataStr = phoneInput.dataset.signupData;
                    if (signupDataStr) {
                        const signupData = JSON.parse(signupDataStr);
                        // Store signup data in session for team switcher
                        sessionStorage.setItem('userProfile', JSON.stringify(signupData.profile));
                        sessionStorage.setItem('userMemberships', JSON.stringify(signupData.memberships));
                    }
                    
                    showSuccess('Welcome to SideSpins! Redirecting...');
                    setTimeout(() => {
                        window.location.href = '/app.html';
                    }, 1500);
                } else {
                    showError(response.message || 'Invalid code. Please try again.');
                    hideLoading();
                    setButtonsEnabled(true);
                }
            } catch (error) {
                console.error('SMS verify error:', error);
                showError('Failed to verify code. Please try again.');
                hideLoading();
                setButtonsEnabled(true);
            }
        });
        
        // Quick sign in for existing users
        sendQuickSmsBtn.addEventListener('click', async function() {
            let formattedPhone;
            
            try {
                formattedPhone = phoneOnlyInput.dataset.cleanNumber || authManager.toE164(phoneOnlyInput.value);
            } catch (error) {
                showError('Please enter a valid phone number');
                return;
            }
            
            try {
                showLoading();
                setButtonsEnabled(false);
                
                const response = await authManager.sendSmsCode(formattedPhone);
                
                if (response.ok) {
                    phoneOnlyInput.dataset.verificationNumber = formattedPhone;
                    phoneOnlySection.style.display = 'none';
                    quickSmsCodeSection.style.display = 'block';
                    showSuccess('Code sent to your phone!');
                } else {
                    showError(response.message || 'Failed to send SMS code. Please try again.');
                }
            } catch (error) {
                console.error('SMS send error:', error);
                showError('Failed to send SMS code. Please try again.');
            } finally {
                hideLoading();
                setButtonsEnabled(true);
            }
        });
        
        // Verify quick sign in SMS
        verifyQuickSmsBtn.addEventListener('click', async function() {
            const phone = phoneOnlyInput.dataset.verificationNumber;
            const code = quickSmsCodeInput.value.trim();
            
            if (!phone) {
                showError('Phone number not found. Please try sending the code again.');
                return;
            }
            
            if (!code || code.length !== 6) {
                showError('Please enter the 6-digit code');
                return;
            }
            
            try {
                showLoading();
                setButtonsEnabled(false);
                
                const response = await authManager.verifySmsCode(phone, code);
                
                if (response.ok) {
                    showSuccess('Login successful! Redirecting...');
                    setTimeout(() => {
                        window.location.href = '/app.html';
                    }, 1500);
                } else {
                    showError(response.message || 'Invalid code. Please try again.');
                    hideLoading();
                    setButtonsEnabled(true);
                }
            } catch (error) {
                console.error('SMS verify error:', error);
                showError('Failed to verify code. Please try again.');
                hideLoading();
                setButtonsEnabled(true);
            }
        });
        
        // Back button handlers
        backToSignupBtn.addEventListener('click', function() {
            smsCodeSection.style.display = 'none';
            apaInputSection.style.display = 'block';
            smsCodeInput.value = '';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        });
        
        backToPhoneBtn.addEventListener('click', function() {
            quickSmsCodeSection.style.display = 'none';
            phoneOnlySection.style.display = 'block';
            quickSmsCodeInput.value = '';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        });
        
        // Check if user is already authenticated
        async function checkCurrentUser() {
            const isAuthenticated = await authManager.checkAuth();
            if (isAuthenticated) {
                window.location.href = '/app.html';
            }
        }
        
        // Check authentication status on page load
        checkCurrentUser();
        
        // Enter key handlers
        apaNumberInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                signupInitBtn.click();
            }
        });
        
        phoneInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                signupInitBtn.click();
            }
        });
        
        smsCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifySmsBtn.click();
            }
        });
        
        phoneOnlyInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuickSmsBtn.click();
            }
        });
        
        quickSmsCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyQuickSmsBtn.click();
            }
        });
    });
    </script>
</body>
</html>